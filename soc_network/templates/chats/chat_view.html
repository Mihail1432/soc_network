<!-- chat_view.html -->

<h2>Chat</h2>

<div class="messages" id="chat-log">
    {% for message in messages %}
        <p><strong>{{ message.sender.username }}:</strong> {{ message.text }} <small>{{ message.timestamp }}</small></p>
    {% endfor %}
</div>

<form id="chat-message-form">
    {% csrf_token %}
    <input id="chat-message-input" type="text" autocomplete="off" placeholder="Enter your message">
    <button id="chat-message-submit">Send</button>
</form>

<script>
    const chatId = "{{ chat.id }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + chatId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').innerHTML += ('<p>' + data.message + '</p>');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>
